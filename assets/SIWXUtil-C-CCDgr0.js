import{rn as e}from"./index-Ekc_aguv.js";import{C as t,F as n,O as r,_ as i,d as a,g as o,k as s,p as c,u as l,v as u,x as d,y as f}from"./ConstantsUtil-BOo-5IWw.js";import{t as p}from"./events-Muq4AJeu.js";p();const m={getSIWX(){return r.state.siwx},async initializeIfEnabled(){let e=r.state.siwx,n=c.getActiveCaipAddress();if(!(e&&n))return;let[a,s,u]=n.split(`:`);if(c.checkIfSupportedNetwork(a))try{if((await e.getSessions(`${a}:${s}`,u)).length)return;await l.open({view:`SIWXSignMessage`})}catch(e){console.error(`SIWXUtil:initializeIfEnabled`,e),t.sendEvent({type:`track`,event:`SIWX_AUTH_ERROR`,properties:this.getSIWXEventProperties()}),await o._getClient()?.disconnect().catch(console.error),d.reset(`Connect`),i.showError(`A problem occurred while trying initialize authentication`)}},async requestSignMessage(){let e=r.state.siwx,a=s.getPlainAddress(c.getActiveCaipAddress()),u=c.getActiveCaipNetwork(),p=o._getClient();if(!e)throw Error(`SIWX is not enabled`);if(!a)throw Error(`No ActiveCaipAddress found`);if(!u)throw Error(`No ActiveCaipNetwork or client found`);if(!p)throw Error(`No ConnectionController client found`);try{let r=await e.createMessage({chainId:u.caipNetworkId,accountAddress:a}),i=r.toString();f.getConnectorId(u.chainNamespace)===n.CONNECTOR_ID.AUTH&&d.pushTransactionStack({});let o=await p.signMessage(i);await e.addSession({data:r,message:i,signature:o}),l.close(),t.sendEvent({type:`track`,event:`SIWX_AUTH_SUCCESS`,properties:this.getSIWXEventProperties()})}catch(e){let n=this.getSIWXEventProperties();(!l.state.open||d.state.view===`ApproveTransaction`)&&await l.open({view:`SIWXSignMessage`}),n.isSmartAccount?i.showError(`This application might not support Smart Accounts`):i.showError(`Signature declined`),t.sendEvent({type:`track`,event:`SIWX_AUTH_ERROR`,properties:n}),console.error(`SWIXUtil:requestSignMessage`,e)}},async cancelSignMessage(){try{this.getSIWX()?.getRequired?.()?await o.disconnect():l.close(),d.reset(`Connect`),t.sendEvent({event:`CLICK_CANCEL_SIWX`,type:`track`,properties:this.getSIWXEventProperties()})}catch(e){console.error(`SIWXUtil:cancelSignMessage`,e)}},async getSessions(){let e=r.state.siwx,t=s.getPlainAddress(c.getActiveCaipAddress()),n=c.getActiveCaipNetwork();return e&&t&&n?e.getSessions(n.caipNetworkId,t):[]},async isSIWXCloseDisabled(){let e=this.getSIWX();if(e){let t=d.state.view===`ApproveTransaction`,n=d.state.view===`SIWXSignMessage`;if(t||n)return e.getRequired?.()&&(await this.getSessions()).length===0}return!1},async universalProviderAuthenticate({universalProvider:e,chains:n,methods:r}){let o=m.getSIWX(),s=new Set(n.map(e=>e.split(`:`)[0]));if(!o||s.size!==1||!s.has(`eip155`))return!1;let l=await o.createMessage({chainId:c.getActiveCaipNetwork()?.caipNetworkId||``,accountAddress:``}),u=await e.authenticate({nonce:l.nonce,domain:l.domain,uri:l.uri,exp:l.expirationTime,iat:l.issuedAt,nbf:l.notBefore,requestId:l.requestId,version:l.version,resources:l.resources,statement:l.statement,chainId:l.chainId,methods:r,chains:[l.chainId,...n.filter(e=>e!==l.chainId)]});if(i.showLoading(`Authenticating...`,{autoClose:!1}),a.setConnectedWalletInfo({...u.session.peer.metadata,name:u.session.peer.metadata.name,icon:u.session.peer.metadata.icons?.[0],type:`WALLET_CONNECT`},Array.from(s)[0]),u?.auths?.length){let n=u.auths.map(t=>{let n=e.client.formatAuthMessage({request:t.p,iss:t.p.iss});return{data:{...t.p,accountAddress:t.p.iss.split(`:`).slice(-1).join(``),chainId:t.p.iss.split(`:`).slice(2,4).join(`:`),uri:t.p.aud,version:t.p.version||l.version,expirationTime:t.p.exp,issuedAt:t.p.iat,notBefore:t.p.nbf},message:n,signature:t.s.s,cacao:t}});try{await o.setSessions(n),t.sendEvent({type:`track`,event:`SIWX_AUTH_SUCCESS`,properties:m.getSIWXEventProperties()})}catch(n){throw console.error(`SIWX:universalProviderAuth - failed to set sessions`,n),t.sendEvent({type:`track`,event:`SIWX_AUTH_ERROR`,properties:m.getSIWXEventProperties()}),await e.disconnect().catch(console.error),n}finally{i.hide()}}return!0},getSIWXEventProperties(){let e=c.state.activeChain;return{network:c.state.activeCaipNetwork?.caipNetworkId||``,isSmartAccount:a.state.preferredAccountTypes?.[e]===u.ACCOUNT_TYPES.SMART_ACCOUNT}},async clearSessions(){let e=this.getSIWX();e&&await e.setSessions([])}};export{m as t};